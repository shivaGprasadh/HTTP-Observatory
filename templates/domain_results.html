{% extends "base.html" %}

{% block title %}{{ domain.hostname }} - Security Results{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Domains</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item active">{{ domain.hostname }}</li>
                </ol>
            </nav>

            <h1 class="display-5 mb-3">
                <i class="fas fa-shield-alt me-3"></i>
                Security Results for {{ domain.hostname }}
            </h1>

            <div class="d-flex gap-2 mb-3">
                <a href="{{ url_for('scan_domain', domain_id=domain.id) }}" class="btn btn-primary">
                    <i class="fas fa-sync-alt me-1"></i>
                    Rescan Domain
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    {% if scans %}
        {% set latest_scan = scans[0] %}

        <!-- Latest Scan Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            Latest Scan Results
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if latest_scan.status == 'completed' %}
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <h3 class="text-{% if latest_scan.overall_score and latest_scan.overall_score >= 80 %}success{% elif latest_scan.overall_score and latest_scan.overall_score >= 50 %}warning{% else %}danger{% endif %}">
                                        {{ latest_scan.overall_score or 'N/A' }}
                                    </h3>
                                    <p class="text-muted mb-0">Overall Score</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 class="text-{% if latest_scan.grade in ['A+', 'A'] %}success{% elif latest_scan.grade in ['B+', 'B'] %}info{% elif latest_scan.grade in ['C+', 'C'] %}warning{% else %}danger{% endif %}">
                                        {{ latest_scan.grade or 'N/A' }}
                                    </h3>
                                    <p class="text-muted mb-0">Security Grade</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 class="text-info">
                                        {{ latest_scan.scan_date.strftime('%Y-%m-%d') if latest_scan.scan_date else 'N/A' }}
                                    </h3>
                                    <p class="text-muted mb-0">Scan Date</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    {% set test_results = latest_scan.csp_issues|from_json if latest_scan.csp_issues else [] %}
                                    {% set failed_tests = test_results|selectattr('status', 'equalto', 'Failed')|list if test_results else [] %}
                                    {% set total_issues = failed_tests|length %}
                                    <h3 class="text-{% if total_issues == 0 %}success{% elif total_issues <= 3 %}warning{% else %}danger{% endif %}">
                                        {{ total_issues }}
                                    </h3>
                                    <p class="text-muted mb-0">Failed Tests</p>
                                </div>
                            </div>
                        {% elif latest_scan.status == 'failed' %}
                            <div class="alert alert-danger" role="alert">
                                <h6 class="alert-heading">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Scan Failed
                                </h6>
                                <p class="mb-0">{{ latest_scan.error_message or 'Unknown error occurred during scan' }}</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Security Issues Breakdown -->
        {% if latest_scan.status == 'completed' %}

        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list me-2"></i>
                            Detailed Security Results
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Test</th>
                                        <th>Score</th>
                                        <th>Reason</th>
                                        <th>Recommendation</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if latest_scan.csp_issues %}
                                        {% set test_results = latest_scan.csp_issues|from_json %}
                                        {% if test_results and test_results is iterable and test_results is not string %}
                                            {% for test_result in test_results %}
                                                <tr class="{% if test_result.status == 'Failed' %}table-danger{% elif test_result.status == 'Passed' %}table-success{% else %}table-light{% endif %}">
                                                    <td><strong>{{ test_result.test_name }}</strong></td>
                                                    <td>
                                                        {% if test_result.score_display %}
                                                            <span class="badge bg-{% if test_result.status == 'Failed' %}danger{% elif test_result.status == 'Passed' %}success{% else %}secondary{% endif %}">
                                                                {{ test_result.score_display }}
                                                            </span>
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <span class="badge bg-{% if test_result.status == 'Failed' %}danger{% elif test_result.status == 'Passed' %}success{% else %}info{% endif %} me-2">
                                                            {{ test_result.status }}
                                                        </span>
                                                        {{ test_result.score_description or 'No description available' }}
                                                    </td>
                                                    <td>{{ test_result.recommendation or 'None' }}</td>
                                                </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="4" class="text-center text-muted">No detailed test results available.</td>
                                            </tr>
                                        {% endif %}
                                    {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No detailed test results available.</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% endif %}

        <!-- CSP Analysis Section -->
        {% if latest_scan.status == 'completed' %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>
                            CSP Analysis
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if latest_scan.csp_issues %}
                            {% set test_results = latest_scan.csp_issues|from_json %}
                            {% set csp_test = test_results|selectattr('test_name', 'equalto', 'Content Security Policy (CSP)')|first %}
                            {% if csp_test %}
                                <div class="alert alert-{% if csp_test.status == 'Failed' %}danger{% elif csp_test.status == 'Passed' %}success{% else %}info{% endif %}" role="alert">
                                    <h6 class="alert-heading">
                                        <span class="badge bg-{% if csp_test.status == 'Failed' %}danger{% elif csp_test.status == 'Passed' %}success{% else %}info{% endif %} me-2">
                                            {{ csp_test.status }}
                                        </span>
                                        Content Security Policy (CSP)
                                    </h6>
                                    <p class="mb-0">{{ csp_test.score_description }}</p>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead>
                                            <tr>
                                                <th>Test</th>
                                                <th>Result</th>
                                                <th>Info</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr class="table-danger">
                                                <td>Blocks execution of inline JavaScript by not allowing 'unsafe-inline' inside script-src</td>
                                                <td><span class="badge bg-danger">Failed</span></td>
                                                <td>Blocking the execution of inline JavaScript provides CSP's strongest protection against cross-site scripting attacks. Moving JavaScript to external files can also help make your site more maintainable.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td>Blocks execution of JavaScript's eval() function by not allowing 'unsafe-eval' inside script-src</td>
                                                <td><span class="badge bg-success">Passed</span></td>
                                                <td>Blocking the use of JavaScript's eval() function can help prevent the execution of untrusted code.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td>Blocks execution of plug-ins, using object-src restrictions</td>
                                                <td><span class="badge bg-success">Passed</span></td>
                                                <td>Blocking the execution of plug-ins via object-src 'none' or as inherited from default-src can prevent attackers from loading Flash or Java in the context of your page.</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td>Blocks inline styles by not allowing 'unsafe-inline' inside style-src</td>
                                                <td><span class="badge bg-danger">Failed</span></td>
                                                <td>Blocking inline styles can help prevent attackers from modifying the contents or appearance of your page. Moving styles to external stylesheets can also help make your site more maintainable.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td>Blocks loading of active content over HTTP or FTP</td>
                                                <td><span class="badge bg-success">Passed</span></td>
                                                <td>Loading JavaScript or plugins can allow a man-in-the-middle to execute arbitrary code or your website. Restricting your policy and changing links to HTTPS can help prevent this.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td>Blocks loading of passive content over HTTP or FTP</td>
                                                <td><span class="badge bg-success">Passed</span></td>
                                                <td>This site's Content Security Policy allows the loading of passive content such as images or videos over insecure protocols such as HTTP or FTP. Consider changing them to load them over HTTPS.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td>Clickjacking protection, using frame-ancestors</td>
                                                <td><span class="badge bg-success">Passed</span></td>
                                                <td>The use of CSP's frame-ancestors directive offers fine-grained control over who can frame your site.</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td>Deny by default, using default-src 'none'</td>
                                                <td><span class="badge bg-danger">Failed</span></td>
                                                <td>Denying by default using default-src 'none' can ensure that your Content Security Policy doesn't allow the loading of resources you didn't intend to allow.</td>
                                            </tr>
                                            <tr class="table-success">
                                                <td>Restricts use of the &lt;base&gt; tag by using base-uri 'none', base-uri 'self', or specific origins</td>
                                                <td><span class="badge bg-success">Passed</span></td>
                                                <td>The &lt;base&gt; tag can be used to trick your site into loading scripts from untrusted origins.</td>
                                            </tr>
                                            <tr class="table-danger">
                                                <td>Restricts where &lt;form&gt; contents may be submitted by using form-action 'none', form-action 'self', or specific URIs</td>
                                                <td><span class="badge bg-danger">Failed</span></td>
                                                <td>Malicious JavaScript or content injection could modify where sensitive form data is submitted to or create additional forms for data exfiltration.</td>
                                            </tr>
                                            <tr class="table-light">
                                                <td>Uses CSP3's 'strict-dynamic' directive to allow dynamic script loading (optional)</td>
                                                <td><span class="badge bg-secondary">-</span></td>
                                                <td>'strict-dynamic' lets you use a JavaScript shim loader to load all your site's JavaScript dynamically, without having to track script-src origins.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info" role="alert">
                                    <p class="mb-0">No CSP analysis data available for this scan.</p>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info" role="alert">
                                <p class="mb-0">No CSP analysis data available for this scan.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Raw Server Headers Section -->
        {% if latest_scan.status == 'completed' %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-server me-2"></i>
                            Raw Server Headers
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if latest_scan.csp_issues %}
                            {% set test_results = latest_scan.csp_issues|from_json %}
                            {% if test_results and test_results[0] and test_results[0].get('scan_info') and test_results[0].scan_info.get('response_headers') %}
                                {% set headers = test_results[0].scan_info.response_headers %}
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead>
                                            <tr>
                                                <th style="width: 30%;">Header</th>
                                                <th>Value</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for header_name, header_value in headers.items() %}
                                            <tr>
                                                <td><strong>{{ header_name|title|replace('-', '-') }}</strong></td>
                                                <td style="word-break: break-all;">{{ header_value }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info" role="alert">
                                    <p class="mb-0">No server headers data available for this scan.</p>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info" role="alert">
                                <p class="mb-0">No server headers data available for this scan.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Scan History -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>
                            Scan History
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Score</th>
                                        <th>Grade</th>
                                        <th>Status</th>
                                        <th>Issues</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for scan in scans %}
                                    <tr class="{% if loop.first %}table-primary{% endif %}">
                                        <td>
                                            <small>{{ scan.scan_date.strftime('%Y-%m-%d %H:%M') if scan.scan_date else 'N/A' }}</small>
                                            {% if loop.first %}<span class="badge bg-primary ms-1">Latest</span>{% endif %}
                                        </td>
                                        <td>
                                            {% if scan.overall_score is not none %}
                                                <span class="badge bg-{% if scan.overall_score >= 80 %}success{% elif scan.overall_score >= 50 %}warning{% else %}danger{% endif %}">
                                                    {{ scan.overall_score }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if scan.grade %}
                                                <span class="badge bg-{% if scan.grade in ['A+', 'A'] %}success{% elif scan.grade in ['B+', 'B'] %}info{% elif scan.grade in ['C+', 'C'] %}warning{% else %}danger{% endif %}">
                                                    {{ scan.grade }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">N/A</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if scan.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif scan.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ scan.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if scan.status == 'completed' %}
                                                {% set test_results = scan.csp_issues|from_json if scan.csp_issues else [] %}
                                                {% set failed_tests = test_results|selectattr('status', 'equalto', 'Failed')|list if test_results else [] %}
                                                {% set total_issues = failed_tests|length %}
                                                <small class="text-{% if total_issues == 0 %}success{% elif total_issues <= 3 %}warning{% else %}danger{% endif %}">
                                                    {{ total_issues }} failed tests
                                                </small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if scan.error_message %}
                                                <small class="text-danger">{{ scan.error_message[:50] }}{% if scan.error_message|length > 50 %}...{% endif %}</small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        <!-- No Scans Available -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No scans available for this domain</h5>
                        <p class="text-muted">Run your first security scan to see detailed results.</p>
                        <a href="{{ url_for('scan_domain', domain_id=domain.id) }}" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>
                            Start First Scan
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}